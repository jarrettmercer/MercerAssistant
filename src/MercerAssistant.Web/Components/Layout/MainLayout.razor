@inherits LayoutComponentBase

<MudThemeProvider Theme="_mercerTheme" IsDarkMode="true" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>
    <MudAppBar Elevation="0" Dense="true" Style="background: rgba(10, 15, 25, 0.75); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px); border-bottom: 1px solid rgba(255,255,255,0.1);">
        <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="ToggleDrawer" />
        <MudText Typo="Typo.h6" Style="font-weight: 700;">
            Mercer<span style="color: #d97706;">Assistant</span>
        </MudText>
        <MudSpacer />
    </MudAppBar>

    <MudDrawer @bind-Open="_drawerOpen" Elevation="0" Variant="DrawerVariant.Mini"
               Style="background: #0a0b10; border-right: 1px solid rgba(255,255,255,0.1);">
        <NavMenu />
        <AuthorizeView>
            <Authorized>
                <div class="drawer-profile">
                    <MudDivider Class="mb-3" Style="border-color: rgba(255,255,255,0.1);" />
                    <div class="profile-section">
                        <div class="profile-avatar">
                            <MudAvatar Color="Color.Primary" Size="Size.Small" Style="font-weight: 600; font-size: 13px;">
                                @GetInitials(context.User.Identity?.Name)
                            </MudAvatar>
                        </div>
                        <div class="profile-info">
                            <MudText Typo="Typo.body2" Style="color: #fff; font-weight: 600; overflow: hidden; text-overflow: ellipsis;">
                                @context.User.Identity?.Name
                            </MudText>
                            <form method="post" action="/account/logout">
                                <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Text" Size="Size.Small"
                                           StartIcon="@Icons.Material.Filled.Logout"
                                           Style="color: #636374; padding: 0; min-width: 0; font-size: 12px; text-transform: none;">
                                    Logout
                                </MudButton>
                            </form>
                        </div>
                    </div>
                </div>
            </Authorized>
        </AuthorizeView>
    </MudDrawer>

    <MudMainContent Style="padding-top: 64px;">
        <div class="page-content">
            @Body
        </div>
    </MudMainContent>
</MudLayout>

<div id="blazor-error-ui" data-nosnippet>
    An unhandled error has occurred.
    <a href="." class="reload">Reload</a>
    <span class="dismiss">X</span>
</div>

@code {
    private bool _drawerOpen = true;

    private readonly MudTheme _mercerTheme = new()
    {
        PaletteDark = new PaletteDark
        {
            Primary = "#d97706",
            Secondary = "#636374",
            Background = "#00050a",
            Surface = "#161616",
            AppbarBackground = "rgba(10, 15, 25, 0.75)",
            DrawerBackground = "#0a0b10",
            TextPrimary = "#ffffff",
            TextSecondary = "#636374",
            ActionDefault = "#d97706",
            ActionDisabled = "#636374",
            Divider = "rgba(255,255,255,0.2)",
            Dark = "#161616",
            DarkContrastText = "#ffffff"
        },
        Typography = new Typography
        {
            Default = new DefaultTypography { FontFamily = ["Inter", "Roboto", "sans-serif"] }
        }
    };

    private void ToggleDrawer()
    {
        _drawerOpen = !_drawerOpen;
    }

    private static string GetInitials(string? name)
    {
        if (string.IsNullOrWhiteSpace(name)) return "?";
        var parts = name.Trim().Split(' ', StringSplitOptions.RemoveEmptyEntries);
        return parts.Length >= 2
            ? $"{parts[0][0]}{parts[^1][0]}".ToUpper()
            : name[..Math.Min(2, name.Length)].ToUpper();
    }
}
